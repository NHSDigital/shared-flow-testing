steps:
 - bash: |
    pip install virtualenv
    virtualenv test_env
    source ./test_env/bin/activate
    pip install -r requirements.txt
   workingDirectory: $(Pipeline.Workspace)/s/$(SERVICE_NAME)/$(SERVICE_ARTIFACT_NAME)/tests
   displayName: Setup integration tests

 - bash: |
     export RELEASE_RELEASEID=$(Build.BuildId)
     export SOURCE_COMMIT_ID=$(Build.SourceVersion)
     export APIGEE_ENVIRONMENT="$(ENVIRONMENT)"
     export SERVICE_BASE_PATH="$(SERVICE_BASE_PATH)"
     export SERVICE_NAME="$(SERVICE_NAME)"
     export STATUS_ENDPOINT_API_KEY="$(status-endpoint-api-key)"
     export JWT_PRIVATE_KEY_ABSOLUTE_PATH="$(Pipeline.Workspace)/secrets/$(JWT_TESTING_PRIVATE_KEY)"
     export ID_TOKEN_NHS_LOGIN_PRIVATE_KEY_ABSOLUTE_PATH="$(Pipeline.Workspace)/secrets/$(ID_TOKEN_NHS_LOGIN_PRIVATE_KEY)"
     export ID_TOKEN_PRIVATE_KEY_ABSOLUTE_PATH="$(Pipeline.Workspace)/secrets/$(ID_TOKEN_TESTING_PRIVATE_KEY)"
     export STATUS_ENDPOINT_API_KEY="$(status-endpoint-api-key)"
     ./test_env/bin/pytest --reruns 5 --reruns-delay 1 -v --junitxml=test-report.xml
   workingDirectory: $(Pipeline.Workspace)/s/$(SERVICE_NAME)/$(SERVICE_ARTIFACT_NAME)/tests
   displayName: run smoketests

 - task: PublishTestResults@2
   displayName: 'Publish smoketest results'
   condition: always()
   inputs:
    testResultsFiles: '$(Pipeline.Workspace)/s/$(SERVICE_NAME)/$(SERVICE_ARTIFACT_NAME)/smoketest-report.xml'
    failTaskOnFailedTests: true
